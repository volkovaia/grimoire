<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è | –ì—Ä–∏–º—É–∞—Ä</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è WebSocket -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="/js/notifications.js"></script>

<nav>
    <a href="/dashboard.html"><i class="fas fa-house"></i> –ö–∞–±–∏–Ω–µ—Ç</a>
    <a href="/spells.html"><i class="fas fa-hat-wizard"></i> –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</a>
    <a href="/artifacts.html"><i class="fas fa-crown"></i> –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</a>
    <a href="/history.html"><i class="fas fa-scroll"></i> –ò—Å—Ç–æ—Ä–∏—è</a>
    <a href="/spell-cast.html"><i class="fas fa-wand-magic-sparkles"></i> –ù–∞–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</a>
    <a href="#" onclick="logout(); return false;"><i class="fas fa-right-from-bracket"></i> –í—ã–π—Ç–∏</a>
</nav>

<h1>–ù–∞–ª–æ–∂–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ</h1>

<div id="notification-container"></div>


<form id="castSpellForm">


    <div class="form-group">
        <label for="targetSelect">–í—ã–±–µ—Ä–∏—Ç–µ –¶–µ–ª—å (–ñ–µ—Ä—Ç–≤—É):</label>
        <select id="targetSelect" class="form-control" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∂–µ—Ä—Ç–≤...</option>
        </select>
    </div>
    <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ ID —Ü–µ–ª–∏ -->
    <input type="hidden" id="targetId" value="" required>


    <div class="form-group">
        <label for="spellSelect">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ:</label>
        <select id="spellSelect" name="spell_id" class="form-control" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π...</option>
        </select>
    </div>


    <div class="form-group">
        <label for="durationSelect">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è:</label>
        <select id="durationSelect" class="form-control" required>
            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî</option>
            <!-- –ó–Ω–∞—á–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö -->
            <option value="60">1 –º–∏–Ω—É—Ç–∞</option>
            <option value="300">5 –º–∏–Ω—É—Ç</option>
            <option value="900">15 –º–∏–Ω—É—Ç</option>
            <option value="3600">1 —á–∞—Å</option>
            <option value="86400">1 –¥–µ–Ω—å</option>
            <option value="">–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–ø–æ–∫–∞ –Ω–µ —Å–Ω–∏–º—É—Ç)</option>
        </select>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–ª–æ–∂–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ" -->
    <button id="castButton" type="submit" class="btn btn-primary">–ù–∞–ª–æ–∂–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ</button>

    <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ -->
    <p id="messageArea" style="margin-top: 15px;"></p>

</form>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ –∫–∞—Å—Ç–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–¥–µ—Å—å: </form> -->

<!-- üí° –ù–û–í–ê–Ø –§–û–†–ú–ê: –°–æ–∑–¥–∞–Ω–∏–µ –ñ–µ—Ä—Ç–≤—ã -->
<div id="newVictimContainer" class="login-form" style="display:none; max-width: 500px; margin: 40px auto 20px;">
    <h3 style="text-align: center;"><i class="fas fa-user-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∂–µ—Ä—Ç–≤—É</h3>
    <form id="createVictimForm">
        <div>
            <label><i class="fas fa-font"></i> –ò–º—è</label>
            <input type="text" id="victimName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω" required />
        </div>
        <div>
            <label><i class="fas fa-user"></i> –§–∞–º–∏–ª–∏—è</label>
            <input type="text" id="victimSurname" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤" required />
        </div>

        <button type="submit">
            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å
        </button>
        <p style="text-align: center; margin-top: 15px;">
            <a href="#" id="showCastForm" style="color: #FFC107; text-decoration: none; font-weight: bold;">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –Ω–∞–ª–æ–∂–µ–Ω–∏—é
            </a>
        </p>
    </form>
</div>

<!-- –°—Å—ã–ª–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–æ—Ä–º -->
<p style="text-align: center; margin-top: 15px;">
    <a href="#" id="showNewVictimForm" style="color: #FFC107; text-decoration: none; font-weight: bold;">
        <i class="fas fa-user-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∂–µ—Ä—Ç–≤—É
    </a>
</p>

<div id="guildUpgradeNotification" class="notification-box" style="display: none; max-width: 600px; margin: 20px auto; border: 1px solid #FFC107; padding: 20px; border-radius: 5px; background-color: #333; box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);">
    <h3 style="color: #FFC107;"><i class="fas fa-arrow-up"></i> –î–æ—Å—Ç—É–ø–Ω–æ —É–ª—É—á—à–µ–Ω–∏–µ –ì–∏–ª—å–¥–∏–∏!</h3>
    <p>–í–∞—à–∞ –≥–∏–ª—å–¥–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ, –≤ –∫–∞–∫—É—é –≥–∏–ª—å–¥–∏—é –í—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–π—Ç–∏:</p>
    <div class="form-group" style="margin-bottom: 15px;">
        <select id="availableGuildsSelect" class="form-control" style="padding: 10px; border-radius: 4px; border: 1px solid #555; background-color: #222; color: white;">
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–∏–ª—å–¥–∏–π...</option>
        </select>
    </div>
    <button id="upgradeGuildButton" type="button" class="btn btn-primary" style="background-color: #FFC107; color: #000; border: none; padding: 10px 15px;">–ü–µ—Ä–µ–π—Ç–∏ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –ì–∏–ª—å–¥–∏—é</button>
    <button id="closeGuildUpgrade" type="button" class="btn btn-secondary" style="margin-left: 10px; padding: 10px 15px;">–û—Ç–ª–æ–∂–∏—Ç—å</button>
    <p id="guildUpgradeMessage" style="margin-top: 15px; font-weight: bold;"></p>
</div>



<script src="/js/api.js"></script>

<script>
    function showError(message) {
        const el = document.getElementById('messageArea');
        if (el) {
            el.textContent = message;
            el.style.color = 'red';
        } else {
            alert('‚ö†Ô∏è ' + message);
        }
    }

    function showMessage(message) {
        const el = document.getElementById('messageArea');
        if (el) {
            el.textContent = message;
            el.style.color = 'green';
        } else {
            alert('‚ö†Ô∏è ' + message);
        }
    }

    function getVictimTypeDisplay(victimType) {
        const type = (victimType || '').toUpperCase();
        switch(type) {
            case 'WIZARD': return '–í–æ–ª—à–µ–±–Ω–∏–∫';
            case 'HUMAN': return '–ß–µ–ª–æ–≤–µ–∫';
            case 'BOTH': return '–û–±–∞';
            default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
    }



    const guildUpgradeContainer = document.getElementById('guildUpgradeNotification');
    const guildSelect = document.getElementById('availableGuildsSelect');
    const upgradeButton = document.getElementById('upgradeGuildButton');
    const closeButton = document.getElementById('closeGuildUpgrade');
    const upgradeMessage = document.getElementById('guildUpgradeMessage');

   /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–∏–ª—å–¥–∏–∏ —á–µ—Ä–µ–∑ API –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞.
     */
    async function showGuildUpgradeChoice() {
        if (!guildUpgradeContainer) return;

        guildSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–∏–ª—å–¥–∏–π...</option>';
        upgradeMessage.textContent = '';
        guildUpgradeContainer.style.display = 'block';

        try {
            // 1. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–∏–ª—å–¥–∏–∏ —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
            let availableGuilds = await api.getAvailableGuilds();

            if (!Array.isArray(availableGuilds) || availableGuilds.length === 0) {
                console.warn("API /guilds/available –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫. –ü–æ–ø—ã—Ç–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å.");

                let currentLevel = 0;
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞–≥–∞, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –µ–≥–æ —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å
                    const wizard = await api.getWizard();
                    // –ï—Å–ª–∏ –º–∞–≥ —Å–æ—Å—Ç–æ–∏—Ç –≤ –≥–∏–ª—å–¥–∏–∏, –±–µ—Ä–µ–º –µ–µ —É—Ä–æ–≤–µ–Ω—å. –ï—Å–ª–∏ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç, —É—Ä–æ–≤–µ–Ω—å 0.
                    currentLevel = wizard.guild ? wizard.guild.level : 0;
                } catch(e) {
                    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞–≥–∞:", e);
                    // –û—Å—Ç–∞–≤–ª—è–µ–º currentLevel = 0 –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                }

                const nextLevel = currentLevel + 1;


                if (nextLevel > 0 && nextLevel <= 4) {
                    console.log(`–†–µ–∑–µ—Ä–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≥–∏–ª—å–¥–∏–π —É—Ä–æ–≤–Ω—è ${nextLevel}...`);
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º API-–º–µ—Ç–æ–¥ getGuildsByLevel, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º findByLevel
                    availableGuilds = await api.getGuildsByLevel(nextLevel);
                } else {
                     console.log(`–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–∏–ª—å–¥–∏–π –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (—Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: ${nextLevel}).`);
                }
            }

            let options = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é –≥–∏–ª—å–¥–∏—é --</option>';
            if (Array.isArray(availableGuilds) && availableGuilds.length > 0) {
                availableGuilds.forEach(guild => {
                    options += `<option value="${guild.id}">${guild.name} (–£—Ä–æ–≤–µ–Ω—å ${guild.level || '?'})</option>`;
                });
            } else {
                options = '<option value="">-- –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–∏–ª—å–¥–∏–π –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ --</option>';
                upgradeButton.disabled = true;
            }
            guildSelect.innerHTML = options;
            upgradeButton.disabled = availableGuilds.length === 0;

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–∏–ª—å–¥–∏–π:', error);
            guildSelect.innerHTML = `<option value="">–û—à–∏–±–∫–∞: ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}</option>`;
            upgradeButton.disabled = true;
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –Ω–æ–≤—É—é –≥–∏–ª—å–¥–∏—é (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É).
     */
    async function handleGuildUpgrade() {
        const newGuildId = guildSelect.value;
        if (!newGuildId) {
            upgradeMessage.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–∏–ª—å–¥–∏—é –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞.';
            upgradeMessage.style.color = 'red';
            return;
        }

        upgradeButton.disabled = true;
        upgradeMessage.textContent = '–ü–µ—Ä–µ—Ö–æ–¥ –≤ –≥–∏–ª—å–¥–∏—é...';
        upgradeMessage.style.color = 'orange';

        try {

            await api.upgradeGuild(Number(newGuildId));

            const selectedGuildName = guildSelect.options[guildSelect.selectedIndex].textContent;
            upgradeMessage.textContent = `‚úÖ –£—Å–ø–µ—à–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥! –í—ã —Ç–µ–ø–µ—Ä—å –≤: ${selectedGuildName}`;
            upgradeMessage.style.color = 'green';

            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—ã–±–æ—Ä–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                guildUpgradeContainer.style.display = 'none';
                upgradeButton.disabled = false;
            }, 3000);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –≥–∏–ª—å–¥–∏—é:', error);
            upgradeMessage.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞: ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}`;
            upgradeMessage.style.color = 'red';
            upgradeButton.disabled = false;
        }
    }

    window.onNotification = function(notification) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–µ–Ω–¥–∞ (NotificationType.GUILD_UPGRADE_AVAILABLE)
        if (notification && notification.type === 'GUILD_UPGRADE_AVAILABLE') {
            console.log("–ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É–ª—É—á—à–µ–Ω–∏–∏ –≥–∏–ª—å–¥–∏–∏. –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤...");
            showGuildUpgradeChoice();
        }

        if (notification && notification.message) {
            showMessage(notification.message);
        }
    }

    // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –∫ –Ω–æ–≤—ã–º –∫–Ω–æ–ø–∫–∞–º
    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        loadSpellsForCasting('spellSelect');
        loadVictimsAndPopulateSelect();

        document.getElementById('castSpellForm')?.addEventListener('submit', handleCastSpellSubmit);

        upgradeButton?.addEventListener('click', handleGuildUpgrade);
        closeButton?.addEventListener('click', () => {
            if (guildUpgradeContainer) guildUpgradeContainer.style.display = 'none';
        });
    });


    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∂–µ—Ä—Ç–≤ –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫. (–ù–µ –∏–∑–º–µ–Ω–µ–Ω–æ, —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
     */
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∂–µ—Ä—Ç–≤ –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫. (–ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±—ä–µ–∫—Ç–∞ wizard)
     */
    async function loadVictimsAndPopulateSelect() {
        const selectElement = document.getElementById('targetSelect');
        const targetIdInput = document.getElementById('targetId');

        selectElement.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∂–µ—Ä—Ç–≤...</option>';
        targetIdInput.value = '';

        try {
            const victims = await api.getAvailableVictims();

            if (!Array.isArray(victims) || victims.length === 0) {
                selectElement.innerHTML = '<option value="">‚Äî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∂–µ—Ä—Ç–≤ ‚Äî</option>';
                return;
            }

            let options = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∂–µ—Ä—Ç–≤—É ‚Äî</option>';
            victims.forEach(victim => {
                const fullName = `${victim.name} ${victim.surname || ''}`.trim();

                let rawVictimType;

                const hasWizardObject = (victim.wizard !== null && victim.wizard !== undefined);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ 'wizard' –ò–õ–ò —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª–µ–π (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                if (hasWizardObject || (Number(victim.wizardId || victim.wizard_id) > 0)) {
                    rawVictimType = 'WIZARD';
                } else {
                    rawVictimType = 'HUMAN';
                }

                const victimTypeDisplay = getVictimTypeDisplay(rawVictimType);

                options += `<option value="${victim.id}">${fullName} (–¢–∏–ø: ${victimTypeDisplay})</option>`;
            });

            selectElement.innerHTML = options;

            selectElement.addEventListener('change', (e) => {
                targetIdInput.value = e.target.value;
            });

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–µ—Ä—Ç–≤:', error);
            selectElement.innerHTML = `<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}</option>`;
            showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–µ—Ä—Ç–≤: ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}`);
        }
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫.
     */
    async function loadSpellsForCasting(selectId) {
        const selectElement = document.getElementById(selectId);
        selectElement.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π...</option>';

        if (!getAuthToken()) {
            selectElement.innerHTML = '<option value="">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</option>';
            return;
        }

        try {
            const data = await api.getMySpells(0, 100);

            selectElement.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ ‚Äî</option>';

            if (data.content && data.content.length > 0) {
                data.content.forEach(spell => {
                    const option = document.createElement('option');
                    option.value = spell.id;

                    const victimType = getVictimTypeDisplay(spell.victimType || spell.victim_type);
                    const description = spell.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';

                    // [ID] –ò–º—è (–û–ø–∏—Å–∞–Ω–∏–µ. –ñ–µ—Ä—Ç–≤–∞: [–¢–∏–ø])
                    option.textContent = `[${spell.id}] ${spell.name} (${description}. –ñ–µ—Ä—Ç–≤–∞: ${victimType})`;

                    selectElement.appendChild(option);
                });
            } else {
                selectElement.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</option>';
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π:', error);
            selectElement.innerHTML = `<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}</option>`;
        }
    }


    async function handleCastSpellSubmit(event) {
        event.preventDefault();

        const targetId = document.getElementById('targetId').value;
        const spellSelect = document.getElementById('spellSelect');
        const spellId = spellSelect.value;
        const messageArea = document.getElementById('messageArea');

        const durationSelect = document.getElementById('durationSelect');
        const durationSeconds = Number(durationSelect.value); // –ó–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –∏–ª–∏ 0, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è"

        let expireTime = null;

        if (durationSeconds > 0) {
            const now = new Date();
            let future = new Date(now.getTime() + durationSeconds * 1000); // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã
            future.setTime(future.getTime() + (3 * 60 * 60 * 1000));
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ ISO 8601 (—Å—Ç—Ä–æ–∫–∞, –æ–∂–∏–¥–∞–µ–º–∞—è –±—ç–∫–µ–Ω–¥–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: 2025-12-01T15:00:00)
            expireTime = future.toISOString().slice(0, 19);
        }

        messageArea.textContent = '–ù–∞–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è...';
        messageArea.style.color = 'orange';

        if (!spellId || !targetId) {
            messageArea.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –∏ –∂–µ—Ä—Ç–≤—É.";
            messageArea.style.color = 'red';
            return;
        }

        try {
            const result = await api.castSpell(parseInt(spellId), parseInt(targetId), expireTime);

            const selectedSpellName = spellSelect.options[spellSelect.selectedIndex].textContent;

            messageArea.textContent = `‚úÖ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ "${result.spellName || selectedSpellName}" —É—Å–ø–µ—à–Ω–æ –Ω–∞–ª–æ–∂–µ–Ω–æ! ${expireTime ? '–ó–∞–≤–µ—Ä—à–∏—Ç—Å—è –≤: ' + new Date(expireTime).toLocaleTimeString('ru-RU') : '–î–µ–π—Å—Ç–≤—É–µ—Ç –±–µ—Å—Å—Ä–æ—á–Ω–æ.'}`;
            messageArea.style.color = 'green';

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –Ω–∞–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è:", error);
            messageArea.textContent = `‚ùå –û—à–∏–±–∫–∞ –Ω–∞–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è: ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}`;
            messageArea.style.color = 'red';
        }
    }


    const castFormEl = document.getElementById('castSpellForm');
    const newVictimContainerEl = document.getElementById('newVictimContainer');
    const createVictimFormEl = document.getElementById('createVictimForm');

    document.getElementById('showNewVictimForm')?.addEventListener('click', (e) => {
        e.preventDefault();
        castFormEl.style.display = 'none';
        newVictimContainerEl.style.display = 'block';
        document.getElementById('showNewVictimForm').style.display = 'none';
    });

    document.getElementById('showCastForm')?.addEventListener('click', (e) => {
        e.preventDefault();
        newVictimContainerEl.style.display = 'none';
        castFormEl.style.display = 'block';
        document.getElementById('showNewVictimForm').style.display = 'block';
    });

    createVictimFormEl?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('victimName').value.trim();
        const surname = document.getElementById('victimSurname').value.trim();

        if (!name || !surname) {
            showError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –¥–ª—è –Ω–æ–≤–æ–π –∂–µ—Ä—Ç–≤—ã');
            return;
        }

        try {
            const newVictim = await api.createVictim(name, surname, true);
            await loadVictimsAndPopulateSelect();

            const selectEl = document.getElementById('targetSelect');
            selectEl.value = newVictim.id;
            document.getElementById('targetId').value = newVictim.id;

            newVictimContainerEl.style.display = 'none';
            castFormEl.style.display = 'block';
            document.getElementById('showNewVictimForm').style.display = 'block';

            showMessage(`‚úÖ –ñ–µ—Ä—Ç–≤–∞ ${newVictim.name} (ID: ${newVictim.id}) —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –∏ –≤—ã–±—Ä–∞–Ω–∞!`);

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∂–µ—Ä—Ç–≤—ã:', err);
            showError(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∂–µ—Ä—Ç–≤—ã: ${err.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}`);
        }
    });

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('wizardId');
        localStorage.removeItem('wizardLogin');
        window.location.href = '/login.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        loadSpellsForCasting('spellSelect');
        loadVictimsAndPopulateSelect();

        document.getElementById('castSpellForm')?.addEventListener('submit', handleCastSpellSubmit);
    });
</script>
</body>
</html>