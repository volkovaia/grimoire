<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è | –ì—Ä–∏–º—É–∞—Ä</title>
    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∏–ª—å, –∫–æ—Ç–æ—Ä—ã–π, —Å—É–¥—è –ø–æ –ª–æ–≥–∞–º, –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav>
    <a href="/dashboard.html"><i class="fas fa-house"></i> –ö–∞–±–∏–Ω–µ—Ç</a>
    <a href="/spells.html"><i class="fas fa-hat-wizard"></i> –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</a>
    <a href="/artifacts.html"><i class="fas fa-crown"></i> –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</a>
    <a href="/history.html"><i class="fas fa-scroll"></i> –ò—Å—Ç–æ—Ä–∏—è</a>
    <a href="/spell-cast.html"><i class="fas fa-wand-magic-sparkles"></i> –ù–∞–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</a>
    <a href="#" onclick="logout(); return false;"><i class="fas fa-right-from-bracket"></i> –í—ã–π—Ç–∏</a>
</nav>

<h1>–ù–∞–ª–æ–∂–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ</h1>

<form id="castSpellForm">

    <!-- –ü–æ–ª–µ ID –í–æ–ª—à–µ–±–Ω–∏–∫–∞ (–ó–∞–∫–ª–∏–Ω–∞—Ç–µ–ª—è) - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç—É -->
<!--    <div class="form-group">-->
<!--        <label for="casterId">ID –í–æ–ª—à–µ–±–Ω–∏–∫–∞ (–ó–∞–∫–ª–∏–Ω–∞—Ç–µ–ª—è):</label>-->
<!--        <input type="text" id="casterId" class="form-control" value="1" readonly required>-->
<!--    </div>-->

    <!-- –ü–æ–ª–µ –í—ã–±–µ—Ä–∏—Ç–µ –¶–µ–ª—å (ID –í–æ–ª—à–µ–±–Ω–∏–∫–∞) - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç—É -->
<!--    <div class="form-group">-->
<!--        <label for="targetId">–í—ã–±–µ—Ä–∏—Ç–µ –¶–µ–ª—å (ID –í–æ–ª—à–µ–±–Ω–∏–∫–∞):</label>-->
<!--        <input type="number" id="targetId" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –≤–æ–ª—à–µ–±–Ω–∏–∫–∞-—Ü–µ–ª–∏" value="2" required>-->
<!--    </div>-->
    <div class="form-group">
        <label for="targetSelect">–í—ã–±–µ—Ä–∏—Ç–µ –¶–µ–ª—å (–ñ–µ—Ä—Ç–≤—É):</label>
        <select id="targetSelect" class="form-control" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∂–µ—Ä—Ç–≤...</option>
        </select>
    </div>
    <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ ID —Ü–µ–ª–∏ (—É–±–µ—Ä–µ–º value="2") -->
    <input type="hidden" id="targetId" value="" required>

    <!-- ***** –ù–û–í–ê–Ø –î–û–ë–ê–í–õ–ï–ù–ù–ê–Ø –ü–õ–ê–®–ö–ê –î–õ–Ø –í–´–ë–û–†–ê –ó–ê–ö–õ–ò–ù–ê–ù–ò–Ø ***** -->
    <div class="form-group">
        <label for="spellSelect">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ:</label>
        <select id="spellSelect" name="spell_id" class="form-control" required>
            <!-- –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: -->
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π...</option>
        </select>
    </div>
    <!-- ************************************************************ -->

    <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–ª–æ–∂–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ" - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç—É -->
    <button id="castButton" type="submit" class="btn btn-primary">–ù–∞–ª–æ–∂–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ</button>

    <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ -->
    <p id="messageArea" style="margin-top: 15px;"></p>

</form>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ –∫–∞—Å—Ç–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–¥–µ—Å—å: </form> -->

<!-- üí° –ù–û–í–ê–Ø –§–û–†–ú–ê: –°–æ–∑–¥–∞–Ω–∏–µ –ñ–µ—Ä—Ç–≤—ã -->
<div id="newVictimContainer" class="login-form" style="display:none; max-width: 500px; margin: 40px auto 20px;">
    <h3 style="text-align: center;"><i class="fas fa-user-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∂–µ—Ä—Ç–≤—É</h3>
    <form id="createVictimForm">
        <div>
            <label><i class="fas fa-font"></i> –ò–º—è</label>
            <input type="text" id="victimName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω" required />
        </div>
        <div>
            <label><i class="fas fa-user"></i> –§–∞–º–∏–ª–∏—è</label>
            <input type="text" id="victimSurname" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤" required />
        </div>

        <button type="submit">
            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å
        </button>
        <p style="text-align: center; margin-top: 15px;">
            <a href="#" id="showCastForm" style="color: #FFC107; text-decoration: none; font-weight: bold;">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –Ω–∞–ª–æ–∂–µ–Ω–∏—é
            </a>
        </p>
    </form>
</div>

<!-- –°—Å—ã–ª–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–æ—Ä–º (–î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ –ø–µ—Ä–µ–¥ <script src="/js/api.js">) -->
<p style="text-align: center; margin-top: 15px;">
    <a href="#" id="showNewVictimForm" style="color: #FFC107; text-decoration: none; font-weight: bold;">
        <i class="fas fa-user-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∂–µ—Ä—Ç–≤—É
    </a>
</p>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ JS-—Ñ–∞–π–ª–∞ -->
<script src="/js/api.js"></script>

<!-- –ù–µ–±–æ–ª—å—à–æ–π inline-—Å–∫—Ä–∏–ø—Ç, —á—Ç–æ–±—ã –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ api.js -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        checkAuth(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

        // –í—ã–∑—ã–≤–∞–µ–º –ù–û–í–£–Æ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –∏–∑ api.js
        //loadArtifactsAndPopulateSelect('spellSelect'); // –ë–æ–ª—å—à–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º URL

         loadSpellsForCasting('spellSelect');

        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ñ–æ—Ä–º—É
        document.getElementById('castSpellForm').addEventListener('submit', handleCastSpellSubmit);
    });

    // ... (–ø–æ—Å–ª–µ loadVictimsAndPopulateSelect –∏ –ø–µ—Ä–µ–¥ document.addEventListener('DOMContentLoaded', ...) )


    // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –°–æ–∑–¥–∞–Ω–∏–µ –ñ–µ—Ä—Ç–≤—ã ---

    const castFormEl = document.getElementById('castSpellForm');
    const newVictimContainerEl = document.getElementById('newVictimContainer');
    const createVictimFormEl = document.getElementById('createVictimForm');

    document.getElementById('showNewVictimForm')?.addEventListener('click', (e) => {
        e.preventDefault();
        castFormEl.style.display = 'none';
        newVictimContainerEl.style.display = 'block';
        document.getElementById('showNewVictimForm').style.display = 'none';
    });

    document.getElementById('showCastForm')?.addEventListener('click', (e) => {
        e.preventDefault();
        newVictimContainerEl.style.display = 'none';
        castFormEl.style.display = 'block';
        document.getElementById('showNewVictimForm').style.display = 'block';
    });


    // üí° –û–ë–†–ê–ë–û–¢–ß–ò–ö –§–û–†–ú–´ –°–û–ó–î–ê–ù–ò–Ø –ñ–ï–†–¢–í–´
    createVictimFormEl?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('victimName').value.trim();
        const surname = document.getElementById('victimSurname').value.trim();

        if (!name || !surname) {
            showError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –¥–ª—è –Ω–æ–≤–æ–π –∂–µ—Ä—Ç–≤—ã');
            return;
        }

        try {
            // –í—ã–∑–æ–≤ –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞ API
            const newVictim = await api.createVictim(name, surname, true);

            // 1. –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∂–µ—Ä—Ç–≤
            await loadVictimsAndPopulateSelect();

            // 2. –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω—É—é –∂–µ—Ä—Ç–≤—É
            const selectEl = document.getElementById('targetSelect');
            selectEl.value = newVictim.id; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ API –≤–µ—Ä–Ω—É–ª newVictim.id

            // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ targetId
            document.getElementById('targetId').value = newVictim.id;

            // 4. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Ñ–æ—Ä–º—É –Ω–∞–ª–æ–∂–µ–Ω–∏—è
            newVictimContainerEl.style.display = 'none';
            castFormEl.style.display = 'block';
            document.getElementById('showNewVictimForm').style.display = 'block';

            showError(`‚úÖ –ñ–µ—Ä—Ç–≤–∞ ${newVictim.name} (ID: ${newVictim.id}) —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –∏ –≤—ã–±—Ä–∞–Ω–∞!`);

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∂–µ—Ä—Ç–≤—ã:', err);
            showError(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∂–µ—Ä—Ç–≤—ã: ${err.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}`);
        }
    });


    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('wizardId');
        localStorage.removeItem('wizardLogin');
        window.location.href = '/login.html';
    }
// ...
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ api.js/–¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ)
    function showError(message) {
        const el = document.getElementById('messageArea');
        if (el) {
            el.textContent = message;
            el.style.color = 'red';
        } else {
            alert('‚ö†Ô∏è ' + message);
        }
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∂–µ—Ä—Ç–≤ –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫.
     */
    async function loadVictimsAndPopulateSelect() {
        const selectElement = document.getElementById('targetSelect');
        const targetIdInput = document.getElementById('targetId');

        selectElement.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∂–µ—Ä—Ç–≤...</option>';
        targetIdInput.value = '';

        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∂–µ—Ä—Ç–≤
            const victims = await api.getAvailableVictims();

            if (!Array.isArray(victims) || victims.length === 0) {
                selectElement.innerHTML = '<option value="">‚Äî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∂–µ—Ä—Ç–≤ ‚Äî</option>';
                return;
            }

            let options = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∂–µ—Ä—Ç–≤—É ‚Äî</option>';
            victims.forEach(victim => {
                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç—ã Human –∏–º–µ—é—Ç –ø–æ–ª—è id, name, surname
                const fullName = `${victim.name} ${victim.surname || ''}`.trim();
                options += `<option value="${victim.id}">${fullName} (ID: ${victim.id})</option>`;
            });

            selectElement.innerHTML = options;

            // –°–≤—è–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤ select —Å –Ω–∞—à–∏–º —Å–∫—Ä—ã—Ç—ã–º –ø–æ–ª–µ–º
            selectElement.addEventListener('change', (e) => {
                targetIdInput.value = e.target.value;
            });

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–µ—Ä—Ç–≤:', error);
            selectElement.innerHTML = `<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}</option>`;
            showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–µ—Ä—Ç–≤: ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}`);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

        // –í—ã–∑—ã–≤–∞–µ–º –ù–û–í–£–Æ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –∏–∑ api.js
        //loadArtifactsAndPopulateSelect('spellSelect'); // –ë–æ–ª—å—à–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º URL

         loadSpellsForCasting('spellSelect');
         loadVictimsAndPopulateSelect();

        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ñ–æ—Ä–º—É
        document.getElementById('castSpellForm').addEventListener('submit', handleCastSpellSubmit);
    });
</script>
</body>
</html>