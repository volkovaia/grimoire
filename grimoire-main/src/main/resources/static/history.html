<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Alfa+Slab+One&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav>
  <a href="/dashboard.html"><i class="fas fa-house"></i> –ö–∞–±–∏–Ω–µ—Ç</a>
  <a href="/spells.html"><i class="fas fa-hat-wizard"></i> –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</a>
  <a href="/artifacts.html"><i class="fas fa-crown"></i> –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</a>
  <a href="/history.html"><i class="fas fa-scroll"></i> –ò—Å—Ç–æ—Ä–∏—è</a>
  <a href="/spell-cast.html"><i class="fas fa-wand-magic-sparkles"></i> –ù–∞–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</a>
  <a href="#" onclick="logout(); return false;"><i class="fas fa-right-from-bracket"></i> –í—ã–π—Ç–∏</a>
</nav>

<div class="magic-header">
  <h2><i class="fas fa-scroll"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</h2>
  <div class="magic-moon"><i class="fas fa-moon"></i></div>
</div>

<!-- üí° –ö–û–ù–¢–ï–ô–ù–ï–† 1: –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è (–ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è, –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∞–º–∏) -->
<div class="info-box">
  <h3><i class="fas fa-hat-wizard"></i> –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è, –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∞–º–∏ (–ê–∫—Ç–∏–≤–Ω—ã–µ)</h3>
  <div id="myCastsContainer">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–∏...</p>
  </div>
</div>

<!-- üí° –ö–û–ù–¢–ï–ô–ù–ï–† 2: –í—Å—è –≤–∏–¥–∏–º–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è -->
<div class="info-box" style="margin-top: 40px;">
  <h3><i class="fas fa-eye"></i> –í—Å—è –≤–∏–¥–∏–º–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</h3>
  <div id="allVisibleCastsContainer">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–π –≤–∏–¥–∏–º–æ–π –∏—Å—Ç–æ—Ä–∏–∏...</p>
  </div>
</div>


<script src="/js/api.js"></script>
<script>
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è
  function getStatusHtml(status) {
      if (status === 'ACTIVE') return `<span class="status-active"><i class="fas fa-circle" style="font-size:0.8em;"></i> –ê–∫—Ç–∏–≤–Ω–æ</span>`;
      if (status === 'REMOVED') return `<span class="status-removed"><i class="fas fa-ban" style="font-size:0.8em;"></i> –°–Ω—è—Ç–æ</span>`;
      if (status === 'EXPIRED') return `<span class="status-expired"><i class="fas fa-history" style="font-size:0.8em;"></i> –ò—Å—Ç–µ–∫–ª–æ</span>`;
      return `<span style="color: #8d7a65;"><i class="fas fa-question-circle"></i> ${status}</span>`;
  }

  // üí° –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –¢–ê–ë–õ–ò–¶–´ –° –ù–û–í–´–ú–ò –°–¢–û–õ–ë–¶–ê–ú–ò
  function createHistoryTable(casts) {
      if (casts.length === 0) {
           return `<div class="no-records"><i class="fas fa-book-open"></i><p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p></div>`;
      }

      const rows = casts.map(c => {
          // üí° –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–†–ï–ú–ï–ù–ò –ù–ê–õ–û–ñ–ï–ù–ò–Ø
          const castTime = new Date(c.castTime).toLocaleString('ru-RU', {
              day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
          });

          // üí° –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–†–ï–ú–ï–ù–ò –û–ö–û–ù–ß–ê–ù–ò–Ø
          const expireTime = c.expireTime
              ? new Date(c.expireTime).toLocaleString('ru-RU', {
                  day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
              })
              : '–ë–µ—Å—Å—Ä–æ—á–Ω–æ'; // ‚¨ÖÔ∏è –¢–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º "–ë–µ—Å—Å—Ä–æ—á–Ω–æ"

          const spellName = c.spell?.name || '‚Äî';
          const casterInfo = c.wizard?.login || `–ú–∞–≥ #${c.wizard?.id || '?'}`;
          const victimInfo = c.victim?.name || `–¶–µ–ª—å #${c.victim?.id || '?'}`;

          return `
              <tr>
                  <td>${spellName}</td>
                  <td>${casterInfo}</td>
                  <td>${victimInfo}</td>
                  <td>${castTime}</td>        <!-- –í—Ä–µ–º—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è -->
                  <td>${expireTime}</td>      <!-- –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
                  <td>${getStatusHtml(c.status)}</td>
              </tr>
          `;
      }).join('');

      // üí° –ò–ó–ú–ï–ù–ï–ù–ò–ï 3: –û–±–Ω–æ–≤–ª—è–µ–º –ó–ê–ì–û–õ–û–í–ö–ò –¢–ê–ë–õ–ò–¶–´
      return `
          <table>
              <thead>
                  <tr>
                      <th><i class="fas fa-spell-check"></i> –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ</th>
                      <th><i class="fas fa-hat-wizard"></i> –ó–∞–∫–ª–∏–Ω–∞—Ç–µ–ª—å</th>
                      <th><i class="fas fa-user"></i> –ñ–µ—Ä—Ç–≤–∞</th>
                      <th><i class="fas fa-clock"></i> –í—Ä–µ–º—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è</th> <!-- üí° –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–û -->
                      <th><i class="fas fa-hourglass-end"></i> –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</th> <!-- üí° –ù–û–í–´–ô –°–¢–û–õ–ë–ï–¶ -->
                      <th><i class="fas fa-info-circle"></i> –°—Ç–∞—Ç—É—Å</th>
                  </tr>
              </thead>
              <tbody>
                  ${rows}
              </tbody>
          </table>
      `;
  }

  async function loadHistory() {
      const myCastsContainer = document.getElementById('myCastsContainer');
      const allVisibleCastsContainer = document.getElementById('allVisibleCastsContainer');

      try {
          checkAuth();
          const wizardId = localStorage.getItem('wizardId');

          const [myCasts, othersCasts] = await Promise.all([
              api.getActiveSpells(),
              api.getOthersActiveSpells()
          ]);

          // 1. –í—Å—è –≤–∏–¥–∏–º–∞—è –∏—Å—Ç–æ—Ä–∏—è
          let allCasts = [
              ...(Array.isArray(myCasts) ? myCasts : []),
              ...(Array.isArray(othersCasts) ? othersCasts : [])
          ];
          const uniqueCasts = allCasts.filter((v, i, a) => a.findIndex(t => t.id === v.id) === i);
          uniqueCasts.sort((a, b) => new Date(b.castTime) - new Date(a.castTime));

          // 2. –¢–æ–ª—å–∫–æ –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è
          const myOnlyCasts = (Array.isArray(myCasts) ? myCasts : [])
              .filter(c => String(c.wizard?.id) === wizardId);
          myOnlyCasts.sort((a, b) => new Date(b.castTime) - new Date(a.castTime));


          // 3. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï
          myCastsContainer.innerHTML = createHistoryTable(myOnlyCasts);
          allVisibleCastsContainer.innerHTML = createHistoryTable(uniqueCasts);

      } catch (err) {
          let errorMessage = err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';

          if (errorMessage.includes("401 UNAUTHORIZED")) {
              errorMessage = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.";
          } else if (errorMessage.includes("500") || errorMessage.includes("Internal server error")) {
              errorMessage = "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (HTTP 500). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Kotlin.";
          }

          const errorHtml = `<p class="message error"><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${errorMessage}</p>`;
          myCastsContainer.innerHTML = errorHtml;
          allVisibleCastsContainer.innerHTML = errorHtml;
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏:", err);
      }
  }

  function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('wizardId');
      localStorage.removeItem('wizardLogin');
      window.location.href = '/login.html';
  }

  loadHistory();
</script>
</body>
</html>