<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>История заклинаний</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Alfa+Slab+One&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav>
  <a href="/dashboard.html"><i class="fas fa-house"></i> Кабинет</a>
  <a href="/spells.html"><i class="fas fa-hat-wizard"></i> Заклинания</a>
  <a href="/artifacts.html"><i class="fas fa-crown"></i> Артефакты</a>
  <a href="/history.html"><i class="fas fa-scroll"></i> История</a>
  <a href="/spell-cast.html"><i class="fas fa-wand-magic-sparkles"></i> Наложение заклинаний</a>
  <a href="#" onclick="logout(); return false;"><i class="fas fa-right-from-bracket"></i> Выйти</a>
</nav>

<div class="magic-header">
  <h2><i class="fas fa-scroll"></i> История заклинаний</h2>
  <div class="magic-moon"><i class="fas fa-moon"></i></div>
</div>

<div class="info-box">
  <h3><i class="fas fa-hat-wizard"></i> Заклинания, наложенные вами (Активные)</h3>
  <div id="myCastsContainer">
    <p>Загрузка вашей истории...</p>
  </div>
</div>

<div class="info-box" style="margin-top: 40px;">
  <h3><i class="fas fa-eye"></i> Вся видимая активная история</h3>
  <div id="allVisibleCastsContainer">
    <p>Загрузка всей видимой истории...</p>
  </div>
</div>


<script src="/js/api.js"></script>

<script>
  function getStatusHtml(status) {
      if (status === 'ACTIVE') return `<span class="status-active"><i class="fas fa-circle" style="font-size:0.8em;"></i> Активно</span>`;
      if (status === 'REMOVED') return `<span class="status-removed"><i class="fas fa-ban" style="font-size:0.8em;"></i> Снято</span>`;
      if (status === 'EXPIRED') return `<span class="status-expired"><i class="fas fa-history" style="font-size:0.8em;"></i> Истекло</span>`;
      return `<span style="color: #8d7a65;"><i class="fas fa-question-circle"></i> ${status}</span>`;
  }

  function createHistoryTable(casts) {
      if (casts.length === 0) {
           return `<div class="no-records"><i class="fas fa-book-open"></i><p>Нет записей.</p></div>`;
      }

      const rows = casts.map(c => {

          // 1. Время наложения
          const castDate = new Date(c.castTime);
          const castTime = castDate.toLocaleString('ru-RU', {
              day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
          });

          // 2. Время окончания
          let expireTimeDisplay = 'Бессрочно';

          if (c.expireTime) {
              // Создаем объект Date, заменяя 'T' на ' ' (чтобы прочитать как локальное время)
              const originalDate = new Date(c.expireTime.replace('T', ' '));


              // let correctedDate = new Date(originalDate);
              // // Добавляем 3 часа (3 * 60 * 60 * 1000 миллисекунд)
              // correctedDate.setTime(correctedDate.getTime() + (3 * 60 * 60 * 1000));

              // Если бэкенд возвращает 05:49, а нужно 07:49 (разница 2 часа):
              // Добавляем 2 часа
              //originalDate.setTime(originalDate.getTime() + (3 * 60 * 60 * 1000));

              // Форматируем скорректированную дату
              expireTimeDisplay = originalDate.toLocaleString('ru-RU', {
                   day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
              });
          }
          const expireTime = expireTimeDisplay;

          const spellName = c.spell?.name || '—';
          const casterInfo = c.wizard?.login || `Маг #${c.wizard?.id || '?'}`;
          const victimInfo = c.victim?.name || `Цель #${c.victim?.id || '?'}`;

          return `
              <tr>
                  <td>${spellName}</td>
                  <td>${casterInfo}</td>
                  <td>${victimInfo}</td>
                  <td>${castTime}</td>        <!-- Время наложения -->
                  <td>${expireTime}</td>      <!-- Время окончания (с ручным смещением) -->
<!--                  <td>${getStatusHtml(c.status)}</td>-->
              </tr>
          `;
      }).join('');

      return `
          <table>
              <thead>
                  <tr>
                      <th><i class="fas fa-spell-check"></i> Заклинание</th>
                      <th><i class="fas fa-hat-wizard"></i> Заклинатель</th>
                      <th><i class="fas fa-user"></i> Жертва</th>
                      <th><i class="fas fa-clock"></i> Время наложения</th>
                      <th><i class="fas fa-hourglass-end"></i> Время окончания</th>
<!--                      <th><i class="fas fa-info-circle"></i> Статус</th>-->
                  </tr>
              </thead>
              <tbody>
                  ${rows}
              </tbody>
          </table>
      `;
  }

 async function loadHistory() {
      const myCastsContainer = document.getElementById('myCastsContainer');
      const allVisibleCastsContainer = document.getElementById('allVisibleCastsContainer');

      let wizardId = null;
      try {
          const token = getAuthToken();
          if (token) {
              const tokenPayload = JSON.parse(atob(token.split('.')[1]));
              wizardId = String(tokenPayload.id);
          }
      } catch (e) {
          console.error("Ошибка парсинга токена:", e);
      }

      if (!wizardId) {
          myCastsContainer.innerHTML = '<p class="message error">Ошибка: Не удалось получить ID Волшебника. Войдите снова.</p>';
          allVisibleCastsContainer.innerHTML = '<p class="message error">Ошибка: Не удалось получить ID Волшебника. Войдите снова.</p>';
          return;
      }


      try {
          checkAuth(); // Проверка авторизации

          const [myCasts, othersCasts] = await Promise.all([
              api.getActiveSpells(),
              api.getOthersActiveSpells()
          ]);

          // сырые строки времени (castTime и expireTime)
          console.log("--- ДАННЫЕ ИСТОРИИ ЗАКЛИНАНИЙ ---");
          console.log("Мои активные заклинания (myCasts):", myCasts);
          console.log("Видимые заклинания (othersCasts):", othersCasts);
          console.log("-----------------------------------------");

          // 1. Вся видимая история
          let allCasts = [
              ...(Array.isArray(myCasts) ? myCasts : []),
              ...(Array.isArray(othersCasts) ? othersCasts : [])
          ];
          // Фильтрация и сортировка
          const uniqueCasts = allCasts.filter((v, i, a) => a.findIndex(t => t.id === v.id) === i);
          uniqueCasts.sort((a, b) => new Date(b.castTime) - new Date(a.castTime));

          const myOnlyCasts = (Array.isArray(myCasts) ? myCasts : [])
              .filter(c => String(c.wizard?.id) === wizardId);
          myOnlyCasts.sort((a, b) => new Date(b.castTime) - new Date(a.castTime));


          // 3. ОТОБРАЖЕНИЕ (остается без изменений)
          myCastsContainer.innerHTML = createHistoryTable(myOnlyCasts);
          allVisibleCastsContainer.innerHTML = createHistoryTable(uniqueCasts);

      } catch (err) {
          let errorMessage = err.message || 'Неизвестная ошибка';

          if (errorMessage.includes("401 UNAUTHORIZED")) {
              errorMessage = "Ошибка авторизации. Войдите снова.";
          } else if (errorMessage.includes("500") || errorMessage.includes("Internal server error")) {
              errorMessage = "Внутренняя ошибка сервера (HTTP 500). Проверьте логи Kotlin.";
          }

          const errorHtml = `<p class="message error"><i class="fas fa-exclamation-triangle"></i> Ошибка: ${errorMessage}</p>`;
          myCastsContainer.innerHTML = errorHtml;
          allVisibleCastsContainer.innerHTML = errorHtml;
          console.error("Ошибка при загрузке истории:", err);
      }
  }

  function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('wizardId');
      localStorage.removeItem('wizardLogin');
      window.location.href = '/login.html';
  }

  document.addEventListener('DOMContentLoaded', loadHistory);
</script>
</body>
</html>