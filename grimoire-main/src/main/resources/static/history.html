<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Alfa+Slab+One&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav>
  <a href="/dashboard.html"><i class="fas fa-house"></i> –ö–∞–±–∏–Ω–µ—Ç</a>
  <a href="/spells.html"><i class="fas fa-hat-wizard"></i> –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</a>
  <a href="/artifacts.html"><i class="fas fa-crown"></i> –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</a>
  <a href="/history.html"><i class="fas fa-scroll"></i> –ò—Å—Ç–æ—Ä–∏—è</a>
  <a href="/spell-cast.html"><i class="fas fa-wand-magic-sparkles"></i> –ù–∞–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</a>
  <a href="#" onclick="logout(); return false;"><i class="fas fa-right-from-bracket"></i> –í—ã–π—Ç–∏</a>
</nav>

<div class="magic-header">
  <h2><i class="fas fa-scroll"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</h2>
  <div class="magic-moon"><i class="fas fa-moon"></i></div>
</div>

<!-- üí° –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† 1: –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è (–ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è, –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∞–º–∏) -->
<div class="info-box">
  <h3><i class="fas fa-hat-wizard"></i> –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è, –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∞–º–∏ (–ê–∫—Ç–∏–≤–Ω—ã–µ)</h3>
  <div id="myCastsContainer">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–∏...</p>
  </div>
</div>

<!-- üí° –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† 2: –ò—Å—Ç–æ—Ä–∏—è, –∫–æ—Ç–æ—Ä—É—é –≤—ã –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å (–í–∫–ª—é—á–∞—è –≤–∞—à—É) -->
<div class="info-box" style="margin-top: 40px;">
  <h3><i class="fas fa-eye"></i> –í—Å—è –≤–∏–¥–∏–º–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</h3>
  <div id="allVisibleCastsContainer">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–π –≤–∏–¥–∏–º–æ–π –∏—Å—Ç–æ—Ä–∏–∏...</p>
  </div>
</div>


<script src="/js/api.js"></script>
<script>
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –∏–∑ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞)
  function getStatusHtml(status) {
      if (status === 'ACTIVE') return `<span class="status-active"><i class="fas fa-circle" style="font-size:0.8em;"></i> –ê–∫—Ç–∏–≤–Ω–æ</span>`;
      if (status === 'REMOVED') return `<span class="status-removed"><i class="fas fa-ban" style="font-size:0.8em;"></i> –°–Ω—è—Ç–æ</span>`;
      if (status === 'EXPIRED') return `<span class="status-expired"><i class="fas fa-history" style="font-size:0.8em;"></i> –ò—Å—Ç–µ–∫–ª–æ</span>`;
      return `<span style="color: #8d7a65;"><i class="fas fa-question-circle"></i> ${status}</span>`;
  }

  function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('wizardId');
      localStorage.removeItem('wizardLogin');
      window.location.href = '/login.html';
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç HTML-—Ç–∞–±–ª–∏—Ü—É –∏–∑ –º–∞—Å—Å–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è—Ö
   * @param {Array} casts –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ SpellCast.
   * @returns {string} HTML-—Ä–∞–∑–º–µ—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã.
   */
  function createHistoryTable(casts) {
      if (casts.length === 0) {
           return `<div class="no-records"><i class="fas fa-book-open"></i><p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p></div>`;
      }

      const rows = casts.map(c => {
          const time = new Date(c.castTime).toLocaleString('ru-RU', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
          });

          const spellName = c.spell?.name || '‚Äî';
          const casterInfo = c.wizard?.login || `–ú–∞–≥ #${c.wizard?.id || '?'}`;
          const victimInfo = c.victim?.name || `–¶–µ–ª—å #${c.victim?.id || '?'}`;

          return `
              <tr>
                  <td>${spellName}</td>
                  <td>${casterInfo}</td>
                  <td>${victimInfo}</td>
                  <td>${time}</td>
                  <td>${getStatusHtml(c.status)}</td>
              </tr>
          `;
      }).join('');

      return `
          <table>
              <thead>
                  <tr>
                      <th><i class="fas fa-spell-check"></i> –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ</th>
                      <th><i class="fas fa-hat-wizard"></i> –ó–∞–∫–ª–∏–Ω–∞—Ç–µ–ª—å</th>
                      <th><i class="fas fa-user"></i> –ñ–µ—Ä—Ç–≤–∞</th>
                      <th><i class="fas fa-clock"></i> –í—Ä–µ–º—è</th>
                      <th><i class="fas fa-info-circle"></i> –°—Ç–∞—Ç—É—Å</th>
                  </tr>
              </thead>
              <tbody>
                  ${rows}
              </tbody>
          </table>
      `;
  }

  async function loadHistory() {
      const myCastsContainer = document.getElementById('myCastsContainer');
      const allVisibleCastsContainer = document.getElementById('allVisibleCastsContainer');

      try {
          checkAuth();
          const wizardId = localStorage.getItem('wizardId'); // ID —Ç–µ–∫—É—â–µ–≥–æ –º–∞–≥–∞ (–µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç–µ)

          // 1. –ó–ê–ì–†–£–ó–ö–ê: –í—Å—è –≤–∏–¥–∏–º–∞—è –∏—Å—Ç–æ—Ä–∏—è (–í–∞—à–∞ + –ß—É–∂–∞—è)
          const [myCasts, othersCasts] = await Promise.all([
              api.getActiveSpells(),      // –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è, –≥–¥–µ –≤—ã ‚Äî –∑–∞–∫–ª–∏–Ω–∞—Ç–µ–ª—å
              api.getOthersActiveSpells() // –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å
          ]);

          // 2. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï: –í—Å—è –≤–∏–¥–∏–º–∞—è –∏—Å—Ç–æ—Ä–∏—è
          let allCasts = [
              ...(Array.isArray(myCasts) ? myCasts : []),
              ...(Array.isArray(othersCasts) ? othersCasts : [])
          ];

          // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã (—Ç.–∫. myCasts –≤–∫–ª—é—á–µ–Ω—ã –≤ othersCasts –∏–ª–∏ –º–æ–≥—É—Ç –ø–µ—Ä–µ—Å–µ–∫–∞—Ç—å—Å—è)
          const uniqueCasts = allCasts.filter((v, i, a) => a.findIndex(t => t.id === v.id) === i);
          uniqueCasts.sort((a, b) => new Date(b.castTime) - new Date(a.castTime));

          // 3. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï: –¢–æ–ª—å–∫–æ –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è (–ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è, –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∞–º–∏)
          // –§–∏–ª—å—Ç—Ä—É–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Å—Ç—ã, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ wizardId —Å–æ–≤–ø–∞–¥–∞–µ—Ç
          // (–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ getActiveSpells –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∞—à–∏ –∫–∞—Å—Ç—ã, –Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
          const myOnlyCasts = (Array.isArray(myCasts) ? myCasts : [])
              .filter(c => String(c.wizard?.id) === wizardId);
          myOnlyCasts.sort((a, b) => new Date(b.castTime) - new Date(a.castTime));


          // 4. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï
          myCastsContainer.innerHTML = createHistoryTable(myOnlyCasts);
          allVisibleCastsContainer.innerHTML = createHistoryTable(uniqueCasts);

      } catch (err) {
          let errorMessage = err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';

          if (errorMessage.includes("401 UNAUTHORIZED")) {
              errorMessage = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.";
          } else if (errorMessage.includes("500") || errorMessage.includes("Internal server error")) {
              errorMessage = "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (HTTP 500). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Kotlin.";
          }

          const errorHtml = `<p class="message error"><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${errorMessage}</p>`;
          myCastsContainer.innerHTML = errorHtml;
          allVisibleCastsContainer.innerHTML = errorHtml;
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏:", err);
      }
  }

  loadHistory();
</script>
</body>
</html>