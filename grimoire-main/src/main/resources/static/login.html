<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Alfa+Slab+One&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="scroll-deco"><i class="fas fa-user-lock"></i></div>

<div class="magic-header">
    <h2><i class="fas fa-user-lock"></i> –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <div class="magic-moon"><i class="fas fa-moon"></i></div>
</div>

<div id="errorMessage" class="message error" style="display:none; max-width:500px; margin:0 auto 20px;">
    <i class="fas fa-exclamation-triangle"></i> <span id="errorText">–û—à–∏–±–∫–∞</span>
</div>

<!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
<form id="loginForm" class="login-form">
    <div>
        <label><i class="fas fa-user"></i> –õ–æ–≥–∏–Ω –º–∞–≥–∞</label>
        <input type="text" id="login" name="login" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: merlin" required />
    </div>
    <div>
        <label><i class="fas fa-key"></i> –ü–∞—Ä–æ–ª—å –æ—Ç –≥—Ä–∏–º—É–∞—Ä–∞</label>
        <input type="password" id="password" name="password" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ" required />
    </div>
    <button type="submit">
        <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
    </button>
    <p style="text-align: center; margin-top: 15px;">
        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="showRegister" style="color: #FFC107; text-decoration: none; font-weight: bold;">
        <i class="fas fa-feather-alt"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    </a>
    </p>
</form>

<!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div id="registrationContainer" style="display:none;">
    <h3 style="text-align: center; margin-top: 30px;"><i class="fas fa-scroll"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –º–∞–≥–∞</h3>
    <form id="registerForm" class="login-form">
        <div>
            <label><i class="fas fa-font"></i> –õ–æ–≥–∏–Ω –º–∞–≥–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)</label>
            <input type="text" id="regLogin" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: merlin" required />
        </div>
        <div>
            <label><i class="fas fa-key"></i> –ü–∞—Ä–æ–ª—å (–Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤)</label>
            <input type="password" id="regPassword" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ" required />
        </div>
        <div>
            <label><i class="fas fa-user"></i> –ò–º—è –º–∞–≥–∞</label>
            <input type="text" id="regName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–µ—Ä–ª–∏–Ω" required />
        </div>
        <div>
            <label><i class="fas fa-user"></i> –§–∞–º–∏–ª–∏—è –º–∞–≥–∞</label>
            <input type="text" id="regSurname" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ—Ä–æ–∫–∏–Ω" required />
        </div>
        <div>
            <label><i class="fas fa-building"></i> ID –≥–∏–ª—å–¥–∏–∏ </label>
            <input type="number" id="regGuildId" placeholder="–ß–∏—Å–ª–æ" value="1" required />
        </div>
        <button type="submit">

            <i class="fas fa-feather-alt"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        </button>
        <p style="text-align: center; margin-top: 30px;">
            <a href="#" id="showLogin" style="color: #FFC107; text-decoration: none; font-weight: bold;">
                <i class="fas fa-sign-in-alt"></i> –ù–∞–∑–∞–¥ –∫–æ –≤—Ö–æ–¥—É
            </a>
        </p>
    </form>
</div>

<!-- Dropdown –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–∏–ª—å–¥–∏–∏ -->
<select id="guildSelect" style="display:none; margin:10px auto; width:300px;" onchange="document.getElementById('regGuildId').value = this.value;">
    <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≥–∏–ª—å–¥–∏—é ‚Äî</option>
</select>

<!-- JS -->
<script>
    // ‚úÖ –ë–∞–∑–æ–≤—ã–π URL –Ω–µ –Ω—É–∂–µ–Ω, –µ—Å–ª–∏ login.html –æ—Ç–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ Spring Boot (http://localhost:8080/login.html)
    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –∫–∞–∫ file:// –∏–ª–∏ —á–µ—Ä–µ–∑ :63342 ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ—Ä—Ç:
    // const API_BASE_URL = 'http://localhost:8080';

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fetch —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π API_BASE_URL (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)
    function apiFetch(url, options = {}) {
        const fullUrl = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : '') + url;
        return fetch(fullUrl, options);
    }



    // üåü –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ –±—ç–∫ –±–µ–∑ wizard –≤ –æ—Ç–≤–µ—Ç–µ)
    document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const login = document.getElementById('regLogin')?.value.trim();
        const password = document.getElementById('regPassword')?.value;
        const name = document.getElementById('regName')?.value.trim();
        const surname = document.getElementById('regSurname')?.value.trim();
        const guildId = Number(document.getElementById('regGuildId')?.value) ||
                        Number(document.getElementById('guildSelect')?.value);

        if (!login || !password || !name || !surname || !guildId) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        try {
            const res = await apiFetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login, password, name, surname, guildId })
            });

            const text = await res.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON: ' + text.substring(0, 100));
            }

            if (!res.ok) {
                const msg = data.message || data.error || JSON.stringify(data);
                throw new Error(msg);
            }

            // ‚úÖ –¢–æ–ª—å–∫–æ token ‚Äî wizard –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
            if (!data || typeof data.token !== 'string') {
                throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–æ–∫–µ–Ω');
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ (–ª–æ–≥–∏–Ω ‚Äî –∏–∑ —Ñ–æ—Ä–º—ã)
            localStorage.setItem('token', data.token);
            localStorage.setItem('wizardId', '0'); // ID –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω ‚Äî –º–æ–∂–Ω–æ 0
            localStorage.setItem('wizardLogin', login);
            localStorage.setItem('guildId', guildId);

            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç...');
            window.location.href = '/dashboard.html';

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', err);
            alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (err.message || err));
        }
    });

    // üåü –í—Ö–æ–¥ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –±—ç–∫ –±–µ–∑ wizard –≤ –æ—Ç–≤–µ—Ç–µ)
    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const login = document.getElementById('login')?.value.trim();
        const password = document.getElementById('password')?.value;

        if (!login || !password) {
            showError('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
            return;
        }

        try {
            const res = await apiFetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login, password })
            });

            const text = await res.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON: ' + text.substring(0, 100));
            }

            if (!res.ok) {
                const msg = data.message || data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                throw new Error(msg);
            }

            // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ token
            if (!data || typeof data.token !== 'string') {
                throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–æ–∫–µ–Ω');
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º (–ª–æ–≥–∏–Ω ‚Äî –∏–∑ —Ñ–æ—Ä–º—ã)
            localStorage.setItem('token', data.token);
            localStorage.setItem('wizardId', '0');
            localStorage.setItem('wizardLogin', login);

            window.location.href = '/dashboard.html';

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', err);
            showError(err.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ');
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º
    const loginFormEl = document.getElementById('loginForm');
    const registerContainerEl = document.getElementById('registrationContainer');
    const showRegisterLink = document.getElementById('showRegister');
    const showLoginLink = document.getElementById('showLogin');
    const guildSelectEl = document.getElementById('guildSelect');

    showRegisterLink?.addEventListener('click', (e) => {
        e.preventDefault();
        loginFormEl.style.display = 'none';
        registerContainerEl.style.display = 'block';
        guildSelectEl.style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    showLoginLink?.addEventListener('click', (e) => {
        e.preventDefault();
        registerContainerEl.style.display = 'none';
        loginFormEl.style.display = 'block';
        guildSelectEl.style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
    function showError(message) {
        const el = document.getElementById('errorMessage');
        if (el) {
            document.getElementById('errorText').textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 6000);
        } else {
            alert('‚ö†Ô∏è ' + message);
        }
    }
</script>
</body>
</html>