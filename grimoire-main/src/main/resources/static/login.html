<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Вход в систему</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Alfa+Slab+One&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">

    <script src="/js/api.js"></script>
</head>
<body>
<div class="scroll-deco"><i class="fas fa-user-lock"></i></div>

<div class="magic-header">
    <h2><i class="fas fa-user-lock"></i> Вход в систему</h2>
    <div class="magic-moon"><i class="fas fa-moon"></i></div>
</div>

<div id="errorMessage" class="message error" style="display:none; max-width:500px; margin:0 auto 20px;">
    <i class="fas fa-exclamation-triangle"></i> <span id="errorText">Ошибка</span>
</div>

<!-- Форма входа -->
<form id="loginForm" class="login-form">
    <div>
        <label><i class="fas fa-user"></i> Логин мага</label>
        <input type="text" id="login" name="login" placeholder="Например: merlin" required />
    </div>
    <div>
        <label><i class="fas fa-key"></i> Пароль от гримуара</label>
        <input type="password" id="password" name="password" placeholder="Секретное слово" required />
    </div>
    <button type="submit">
        <i class="fas fa-sign-in-alt"></i> Войти
    </button>
    <p style="text-align: center; margin-top: 15px;">
        Нет аккаунта? <a href="#" id="showRegister" style="color: #FFC107; text-decoration: none; font-weight: bold;">
        <i class="fas fa-feather-alt"></i> Зарегистрироваться
    </a>
    </p>
</form>

<!-- Форма регистрации -->
<div id="registrationContainer" style="display:none;">
    <h3 style="text-align: center; margin-top: 30px;"><i class="fas fa-scroll"></i> Регистрация нового мага</h3>
    <form id="registerForm" class="login-form">
        <div>
            <label><i class="fas fa-font"></i> Логин мага (уникальный)</label>
            <input type="text" id="regLogin" placeholder="Например: merlin" required />
        </div>
        <div>
            <label><i class="fas fa-key"></i> Пароль (не менее 6 символов)</label>
            <input type="password" id="regPassword" placeholder="Секретное слово" required />
        </div>
        <div>
            <label><i class="fas fa-user"></i> Имя мага</label>
            <input type="text" id="regName" placeholder="Например: Мерлин" required />
        </div>
        <div>
            <label><i class="fas fa-user"></i> Фамилия мага</label>
            <input type="text" id="regSurname" placeholder="Например: Сорокин" required />
        </div>

        <!-- Выбор УРОВНЯ гильдии -->
        <div>
            <label><i class="fas fa-layer-group"></i> Требуемый уровень гильдии</label>
            <select id="regGuildLevelSelect" required>
                <option value="">— Выберите уровень —</option>
                <option value="1">Уровень 1</option>
                <option value="2">Уровень 2</option>
                <option value="3">Уровень 3</option>
                <option value="4">Уровень 4</option>
            </select>
        </div>

        <div>
            <label><i class="fas fa-building"></i> Выберите гильдию</label>
            <select id="guildSelectForForm" required disabled>
                <option value="">— Выберите уровень, чтобы загрузить гильдии —</option>
            </select>
        </div>

        <input type="hidden" id="regGuildId" value="" required />

        <button type="submit">
            <i class="fas fa-feather-alt"></i> Зарегистрироваться
        </button>
        <p style="text-align: center; margin-top: 30px;">
            <a href="#" id="showLogin" style="color: #FFC107; text-decoration: none; font-weight: bold;">
                <i class="fas fa-sign-in-alt"></i> Назад ко входу
            </a>
        </p>
    </form>
</div>

<script>
    function apiFetch(url, options = {}) {
        const fullUrl = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : '') + url;
        return fetch(fullUrl, options);
    }

    const guildLevelSelectEl = document.getElementById('regGuildLevelSelect');
    const guildSelectForFormEl = document.getElementById('guildSelectForForm');
    const regGuildIdInputEl = document.getElementById('regGuildId');


    /**
     * Загружает гильдии по выбранному уровню и заполняет dropdown.
     * Использует новый метод api.getGuildsByLevel().
     * @param {number} level Уровень гильдии.
     */
    async function fetchGuildsByLevel(level) {
        if (!level) {
            guildSelectForFormEl.innerHTML = '<option value="">— Выберите уровень, чтобы загрузить гильдии —</option>';
            guildSelectForFormEl.disabled = true;
            regGuildIdInputEl.value = '';
            return;
        }

        guildSelectForFormEl.innerHTML = '<option value="">— Загрузка... —</option>';
        guildSelectForFormEl.disabled = true;
        regGuildIdInputEl.value = '';

        try {
            // Использование метода из api.js
            const guilds = await api.getGuildsByLevel(level);

            if (!Array.isArray(guilds) || guilds.length === 0) {
                guildSelectForFormEl.innerHTML = '<option value="">— Нет доступных гильдий этого уровня —</option>';
                return;
            }

            // Заполняем Select
            let options = '<option value="">— Выберите гильдию —</option>';
            guilds.forEach(guild => {
                const idValue = guild.id || guild.guild_id;

                    if (idValue === undefined || idValue === null) {
                        // Пропускаем объект без ID или логируем ошибку
                        console.warn('Объект гильдии не содержит поля "id" или "guild_id":', guild);
                        return;
                    }
                options += `<option value="${idValue}">${guild.name} (ID: ${idValue})</option>`;
            });

            guildSelectForFormEl.innerHTML = options;
            guildSelectForFormEl.disabled = false;

        } catch (err) {
            console.error('Ошибка при загрузке гильдий:', err);
            showError(`Ошибка загрузки гильдий: ${err.message || 'Неизвестная ошибка'}`);
            guildSelectForFormEl.innerHTML = `<option value="">— Ошибка загрузки —</option>`;
        }
    }

    // Обработчик изменения уровня гильдии
    guildLevelSelectEl?.addEventListener('change', (e) => {
        const selectedLevel = e.target.value;
        // Очистка предыдущего выбора гильдии
        regGuildIdInputEl.value = '';
        fetchGuildsByLevel(selectedLevel);
    });

    // Обработчик изменения выбранной гильдии
    guildSelectForFormEl?.addEventListener('change', (e) => {
        // Обновляем скрытое поле с ID гильдии для отправки
        regGuildIdInputEl.value = e.target.value;
    });


    document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const login = document.getElementById('regLogin')?.value.trim();
        const password = document.getElementById('regPassword')?.value;
        const name = document.getElementById('regName')?.value.trim();
        const surname = document.getElementById('regSurname')?.value.trim();

        const guildId = Number(regGuildIdInputEl?.value);

        // Проверяем, что guildId выбран
        if (!login || !password || !name || !surname || !guildId) {
            alert('❌ Пожалуйста, заполните все поля (включая выбор гильдии)');
            return;
        }

        try {
            const res = await apiFetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login, password, name, surname, guildId })
            });

            const text = await res.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('Сервер вернул не-JSON: ' + text.substring(0, 100));
            }

            if (!res.ok) {
                const msg = data.message || data.error || JSON.stringify(data);
                throw new Error(msg);
            }

            if (!data || typeof data.token !== 'string') {
                throw new Error('Сервер не вернул токен');
            }

            localStorage.setItem('token', data.token);
            localStorage.setItem('wizardId', '0'); // ID неизвестен — можно 0
            localStorage.setItem('wizardLogin', login);
            localStorage.setItem('guildId', guildId);

            alert('✅ Регистрация успешна! Переход в кабинет...');
            window.location.href = '/dashboard.html';

        } catch (err) {
            console.error('Ошибка регистрации:', err);
            alert('❌ Ошибка регистрации: ' + (err.message || err));
        }
    });

    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const login = document.getElementById('login')?.value.trim();
        const password = document.getElementById('password')?.value;

        if (!login || !password) {
            showError('Введите логин и пароль');
            return;
        }

        try {
            const res = await apiFetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login, password })
            });

            const text = await res.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('Сервер вернул не-JSON: ' + text.substring(0, 100));
            }

            if (!res.ok) {
                const msg = data.message || data.error || 'Неверный логин или пароль';
                throw new Error(msg);
            }

            if (!data || typeof data.token !== 'string') {
                throw new Error('Сервер не вернул токен');
            }

            // Сохраняем (логин — из формы)
            localStorage.setItem('token', data.token);
            localStorage.setItem('wizardId', '0');
            localStorage.setItem('wizardLogin', login);

            window.location.href = '/dashboard.html';

        } catch (err) {
            console.error('Ошибка входа:', err);
            showError(err.message || 'Произошла ошибка при входе');
        }
    });

    // Переключение форм
    const loginFormEl = document.getElementById('loginForm');
    const registerContainerEl = document.getElementById('registrationContainer');
    const showRegisterLink = document.getElementById('showRegister');
    const showLoginLink = document.getElementById('showLogin');

    showRegisterLink?.addEventListener('click', (e) => {
        e.preventDefault();
        loginFormEl.style.display = 'none';
        registerContainerEl.style.display = 'block';

        // Автоматическая загрузка гильдий при открытии формы, если выбран уровень
        if (guildLevelSelectEl.value) {
             fetchGuildsByLevel(guildLevelSelectEl.value);
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    showLoginLink?.addEventListener('click', (e) => {
        e.preventDefault();
        registerContainerEl.style.display = 'none';
        loginFormEl.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Вспомогательная функция отображения ошибки
    function showError(message) {
        const el = document.getElementById('errorMessage');
        if (el) {
            document.getElementById('errorText').textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 6000);
        } else {
            alert('⚠️ ' + message);
        }
    }
</script>
</body>
</html>