<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Alfa+Slab+One&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">

    <script src="/js/api.js"></script>
</head>
<body>
<div class="scroll-deco"><i class="fas fa-user-lock"></i></div>

<div class="magic-header">
    <h2><i class="fas fa-user-lock"></i> –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <div class="magic-moon"><i class="fas fa-moon"></i></div>
</div>

<div id="errorMessage" class="message error" style="display:none; max-width:500px; margin:0 auto 20px;">
    <i class="fas fa-exclamation-triangle"></i> <span id="errorText">–û—à–∏–±–∫–∞</span>
</div>

<!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
<form id="loginForm" class="login-form">
    <div>
        <label><i class="fas fa-user"></i> –õ–æ–≥–∏–Ω –º–∞–≥–∞</label>
        <input type="text" id="login" name="login" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: merlin" required />
    </div>
    <div>
        <label><i class="fas fa-key"></i> –ü–∞—Ä–æ–ª—å –æ—Ç –≥—Ä–∏–º—É–∞—Ä–∞</label>
        <input type="password" id="password" name="password" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ" required />
    </div>
    <button type="submit">
        <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
    </button>
    <p style="text-align: center; margin-top: 15px;">
        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="showRegister" style="color: #FFC107; text-decoration: none; font-weight: bold;">
        <i class="fas fa-feather-alt"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    </a>
    </p>
</form>

<!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div id="registrationContainer" style="display:none;">
    <h3 style="text-align: center; margin-top: 30px;"><i class="fas fa-scroll"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –º–∞–≥–∞</h3>
    <form id="registerForm" class="login-form">
        <div>
            <label><i class="fas fa-font"></i> –õ–æ–≥–∏–Ω –º–∞–≥–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)</label>
            <input type="text" id="regLogin" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: merlin" required />
        </div>
        <div>
            <label><i class="fas fa-key"></i> –ü–∞—Ä–æ–ª—å (–Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤)</label>
            <input type="password" id="regPassword" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ" required />
        </div>
        <div>
            <label><i class="fas fa-user"></i> –ò–º—è –º–∞–≥–∞</label>
            <input type="text" id="regName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–µ—Ä–ª–∏–Ω" required />
        </div>
        <div>
            <label><i class="fas fa-user"></i> –§–∞–º–∏–ª–∏—è –º–∞–≥–∞</label>
            <input type="text" id="regSurname" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ—Ä–æ–∫–∏–Ω" required />
        </div>

        <!-- –í—ã–±–æ—Ä –£–†–û–í–ù–Ø –≥–∏–ª—å–¥–∏–∏ -->
        <div>
            <label><i class="fas fa-layer-group"></i> –¢—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –≥–∏–ª—å–¥–∏–∏</label>
            <select id="regGuildLevelSelect" required>
                <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å ‚Äî</option>
                <option value="1">–£—Ä–æ–≤–µ–Ω—å 1</option>
                <option value="2">–£—Ä–æ–≤–µ–Ω—å 2</option>
                <option value="3">–£—Ä–æ–≤–µ–Ω—å 3</option>
                <option value="4">–£—Ä–æ–≤–µ–Ω—å 4</option>
                <!-- –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ —É—Ä–æ–≤–Ω–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ –ë–î -->
            </select>
        </div>

        <!-- –í—ã–±–æ—Ä –ì–ò–õ–¨–î–ò–ò, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        <div>
            <label><i class="fas fa-building"></i> –í—ã–±–µ—Ä–∏—Ç–µ –≥–∏–ª—å–¥–∏—é</label>
            <select id="guildSelectForForm" required disabled>
                <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–∏–ª—å–¥–∏–∏ ‚Äî</option>
            </select>
        </div>

        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π guildId –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä -->
        <input type="hidden" id="regGuildId" value="" required />

        <button type="submit">
            <i class="fas fa-feather-alt"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        </button>
        <p style="text-align: center; margin-top: 30px;">
            <a href="#" id="showLogin" style="color: #FFC107; text-decoration: none; font-weight: bold;">
                <i class="fas fa-sign-in-alt"></i> –ù–∞–∑–∞–¥ –∫–æ –≤—Ö–æ–¥—É
            </a>
        </p>
    </form>
</div>

<!-- JS -->
<script>
    function apiFetch(url, options = {}) {
        const fullUrl = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : '') + url;
        return fetch(fullUrl, options);
    }
    // ‚úÖ –ï—Å–ª–∏ api.js –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –≤–Ω–µ—à–Ω–µ, –≤–∞–º –Ω—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ apiFetch –∏ const api = {...} —Å—é–¥–∞

    // --- –ù–û–í–´–ô –ö–û–î –î–õ–Ø –í–´–ë–û–†–ê –ì–ò–õ–¨–î–ò–ò –ü–û –£–†–û–í–ù–Æ ---

    // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã (–≤–º–µ—Å—Ç–æ guildSelectEl –∏—Å–ø–æ–ª—å–∑—É–µ–º guildSelectForFormEl)
    const guildLevelSelectEl = document.getElementById('regGuildLevelSelect');
    const guildSelectForFormEl = document.getElementById('guildSelectForForm');
    const regGuildIdInputEl = document.getElementById('regGuildId');


    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≥–∏–ª—å–¥–∏–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —É—Ä–æ–≤–Ω—é –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç dropdown.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ api.getGuildsByLevel().
     * @param {number} level –£—Ä–æ–≤–µ–Ω—å –≥–∏–ª—å–¥–∏–∏.
     */
    async function fetchGuildsByLevel(level) {
        if (!level) {
            guildSelectForFormEl.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–∏–ª—å–¥–∏–∏ ‚Äî</option>';
            guildSelectForFormEl.disabled = true;
            regGuildIdInputEl.value = '';
            return;
        }

        guildSelectForFormEl.innerHTML = '<option value="">‚Äî –ó–∞–≥—Ä—É–∑–∫–∞... ‚Äî</option>';
        guildSelectForFormEl.disabled = true;
        regGuildIdInputEl.value = '';

        try {
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –∏–∑ api.js
            const guilds = await api.getGuildsByLevel(level);

            if (!Array.isArray(guilds) || guilds.length === 0) {
                guildSelectForFormEl.innerHTML = '<option value="">‚Äî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–∏–ª—å–¥–∏–π —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è ‚Äî</option>';
                return;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º Select
            let options = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≥–∏–ª—å–¥–∏—é ‚Äî</option>';
            guilds.forEach(guild => {
                const idValue = guild.id || guild.guild_id;

                    if (idValue === undefined || idValue === null) {
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—ä–µ–∫—Ç –±–µ–∑ ID –∏–ª–∏ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                        console.warn('–û–±—ä–µ–∫—Ç –≥–∏–ª—å–¥–∏–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª—è "id" –∏–ª–∏ "guild_id":', guild);
                        return;
                    }
                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç—ã –≥–∏–ª—å–¥–∏–π –∏–º–µ—é—Ç –ø–æ–ª—è guild_id –∏ name
                options += `<option value="${idValue}">${guild.name} (ID: ${idValue})</option>`;
            });

            guildSelectForFormEl.innerHTML = options;
            guildSelectForFormEl.disabled = false;

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥–∏–ª—å–¥–∏–π:', err);
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º showError, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∏–ª—å–¥–∏–π: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            guildSelectForFormEl.innerHTML = `<option value="">‚Äî –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî</option>`;
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –≥–∏–ª—å–¥–∏–∏
    guildLevelSelectEl?.addEventListener('change', (e) => {
        const selectedLevel = e.target.value;
        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—ã–±–æ—Ä–∞ –≥–∏–ª—å–¥–∏–∏
        regGuildIdInputEl.value = '';
        fetchGuildsByLevel(selectedLevel);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥–∏–ª—å–¥–∏–∏
    guildSelectForFormEl?.addEventListener('change', (e) => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å ID –≥–∏–ª—å–¥–∏–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        regGuildIdInputEl.value = e.target.value;
    });

    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê –î–õ–Ø –í–´–ë–û–†–ê –ì–ò–õ–¨–î–ò–ò ---


    // üåü –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ –±—ç–∫ –±–µ–∑ wizard –≤ –æ—Ç–≤–µ—Ç–µ)
    document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const login = document.getElementById('regLogin')?.value.trim();
        const password = document.getElementById('regPassword')?.value;
        const name = document.getElementById('regName')?.value.trim();
        const surname = document.getElementById('regSurname')?.value.trim();
        // –ë–µ—Ä–µ–º ID —Ç–æ–ª—å–∫–æ –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è (–∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ –≤—ã–±–æ—Ä)
        const guildId = Number(regGuildIdInputEl?.value);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ guildId –≤—ã–±—Ä–∞–Ω
        if (!login || !password || !name || !surname || !guildId) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è (–≤–∫–ª—é—á–∞—è –≤—ã–±–æ—Ä –≥–∏–ª—å–¥–∏–∏)');
            return;
        }

        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π fetch, –µ—Å–ª–∏ apiFetch –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —ç—Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ,
            // –∏–ª–∏ apiFetch, –µ—Å–ª–∏ –æ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π. –ò—Å–ø–æ–ª—å–∑—É–µ–º apiFetch, –∫–∞–∫ —Ä–∞–Ω—å—à–µ.
            const res = await apiFetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login, password, name, surname, guildId })
            });

            const text = await res.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON: ' + text.substring(0, 100));
            }

            if (!res.ok) {
                const msg = data.message || data.error || JSON.stringify(data);
                throw new Error(msg);
            }

            // ‚úÖ –¢–æ–ª—å–∫–æ token ‚Äî wizard –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
            if (!data || typeof data.token !== 'string') {
                throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–æ–∫–µ–Ω');
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ (–ª–æ–≥–∏–Ω ‚Äî –∏–∑ —Ñ–æ—Ä–º—ã)
            localStorage.setItem('token', data.token);
            localStorage.setItem('wizardId', '0'); // ID –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω ‚Äî –º–æ–∂–Ω–æ 0
            localStorage.setItem('wizardLogin', login);
            localStorage.setItem('guildId', guildId);

            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç...');
            window.location.href = '/dashboard.html';

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', err);
            alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (err.message || err));
        }
    });

    // üåü –í—Ö–æ–¥ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –±—ç–∫ –±–µ–∑ wizard –≤ –æ—Ç–≤–µ—Ç–µ)
    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const login = document.getElementById('login')?.value.trim();
        const password = document.getElementById('password')?.value;

        if (!login || !password) {
            showError('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
            return;
        }

        try {
            const res = await apiFetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login, password })
            });

            const text = await res.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON: ' + text.substring(0, 100));
            }

            if (!res.ok) {
                const msg = data.message || data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                throw new Error(msg);
            }

            // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ token
            if (!data || typeof data.token !== 'string') {
                throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–æ–∫–µ–Ω');
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º (–ª–æ–≥–∏–Ω ‚Äî –∏–∑ —Ñ–æ—Ä–º—ã)
            localStorage.setItem('token', data.token);
            localStorage.setItem('wizardId', '0');
            localStorage.setItem('wizardLogin', login);

            window.location.href = '/dashboard.html';

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', err);
            showError(err.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ');
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º
    const loginFormEl = document.getElementById('loginForm');
    const registerContainerEl = document.getElementById('registrationContainer');
    const showRegisterLink = document.getElementById('showRegister');
    const showLoginLink = document.getElementById('showLogin');

    showRegisterLink?.addEventListener('click', (e) => {
        e.preventDefault();
        loginFormEl.style.display = 'none';
        registerContainerEl.style.display = 'block';

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≥–∏–ª—å–¥–∏–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —É—Ä–æ–≤–µ–Ω—å
        if (guildLevelSelectEl.value) {
             fetchGuildsByLevel(guildLevelSelectEl.value);
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    showLoginLink?.addEventListener('click', (e) => {
        e.preventDefault();
        registerContainerEl.style.display = 'none';
        loginFormEl.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
    function showError(message) {
        const el = document.getElementById('errorMessage');
        if (el) {
            document.getElementById('errorText').textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 6000);
        } else {
            alert('‚ö†Ô∏è ' + message);
        }
    }
</script>
</body>
</html>