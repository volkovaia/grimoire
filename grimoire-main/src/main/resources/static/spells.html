<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Каталог заклинаний</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Alfa+Slab+One&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav>
    <a href="/dashboard.html"><i class="fas fa-house"></i> Кабинет</a>
    <a href="/spells.html"><i class="fas fa-hat-wizard"></i> Заклинания</a>
    <a href="/artifacts.html"><i class="fas fa-crown"></i> Артефакты</a>
    <a href="/history.html"><i class="fas fa-scroll"></i> История</a>
    <a href="/spell-cast.html"><i class="fas fa-wand-magic-sparkles"></i> Наложение заклинаний</a>
    <a href="#" onclick="logout(); return false;"><i class="fas fa-right-from-bracket"></i> Выйти</a>
</nav>

<div class="magic-header">
    <h2><i class="fas fa-spell-check"></i> Каталог всех заклинаний</h2>
    <div class="magic-moon"><i class="fas fa-star"></i></div>
</div>

<div id="spellsContainer">
    <p>Загрузка заклинаний...</p>
</div>

<script src="/js/api.js"></script>
<script>
    /**
     * Возвращает HTML с иконкой для типа жертвы.
     * @param {string} victimType Тип жертвы (например, WIZARD, HUMAN, BOTH).
     * @returns {string} HTML с иконкой и текстом.
     */
    function getVictimTypeHtml(victimType) {
        const type = (victimType || '').toUpperCase();
        let icon = '';
        let color = '#d4af37'; // Желтый/золотой
        let text = 'Неизвестно';

        switch(type) {
            case 'WIZARD':
                icon = 'fa-hat-wizard';
                color = '#5bc0de'; // Голубой
                text = 'Волшебник';
                break;
            case 'HUMAN':
                icon = 'fa-user';
                color = '#f0ad4e'; // Оранжевый
                text = 'Человек';
                break;
            case 'BOTH':
                icon = 'fa-users';
                color = '#62c462'; // Зеленый
                text = 'Оба';
                break;
            default:
                icon = 'fa-question';
                text = 'Неизвестно';
        }

        return `<span style="color:${color};"><i class="fas ${icon}" title="${text}"></i> ${text}</span>`;
    }

    async function loadSpells() {
        try {
            checkAuth();
            const spells = await api.getAllSpells(0, 100);
            const wizard = await api.getWizard();
            const container = document.getElementById('spellsContainer');

            if (spells.content.length === 0) {
                container.innerHTML = `
                    <div class="no-records">
                        <i class="fas fa-book"></i>
                        <p>В гримуаре нет записанных заклинаний.</p>
                    </div>
                `;
                return;
            }

            const rows = spells.content.map(spell => {
                const isAvailable = spell.requiredGuildLevel <= wizard.guild.level;

                const descriptionHtml = `<br><span style="font-size: 0.9em; color: #aaa; font-style: italic;">${spell.description || 'Нет описания.'}</span>`;


                const victimTypeDisplay = getVictimTypeHtml(spell.victimType);

                const actionBtn = isAvailable
                    ? `<a href="/spell-cast.html?spellId=${spell.id}" class="btn" style="display:inline-block;padding:6px 14px;font-size:0.95em;background:#5d4037;color:#e0d6c5;text-decoration:none;border-radius:4px;">
                        <i class="fas fa-bolt"></i> Наложить
                      </a>`
                    : `<span style="color:#888;"><i class="fas fa-lock"></i> Недоступно</span>`;

                const typeHtml = {
                    'ATTACK': `<span style="color:#ff5252;"><i class="fas fa-skull-crossbones"></i> Атака</span>`,
                    'DEFENSE': `<span style="color:#4caf50;"><i class="fas fa-shield-halved"></i> Защита</span>`,
                    'CONTROL': `<span style="color:#2196f3;"><i class="fas fa-hand-sparkles"></i> Контроль</span>`,
                    'UTILITY': `<span style="color:#ffd700;"><i class="fas fa-star"></i> UTILITY</span>`,
                    'CURSE': `<span style="color:#9c27b0;"><i class="fas fa-ban"></i> CURSE</span>`,
                    'NECROMANCY': `<span style="color:#008080;"><i class="fas fa-skull"></i> NECROMANCY</span>`,
                    'ILLUSION': `<span style="color:#6a5acd;"><i class="fas fa-eye"></i> ILLUSION</span>`,
                    'BUFF': `<span style="color:#ffc107;"><i class="fas fa-arrow-up"></i> BUFF</span>`,
                    'FORBIDDEN_MAGIC': `<span style="color:#800000; font-weight: bold;"><i class="fas fa-exclamation-triangle"></i> ЗАПРЕЩ.</span>`,

                }[spell.type] || `<span>${spell.type}</span>`;


                return `
                    <tr>
                        <td>${spell.name}${descriptionHtml}</td>
                        <td>${spell.requiredGuildLevel}</td>
                        <td>${typeHtml}</td>
                        <td>${victimTypeDisplay}</td>
                    </tr>
                `;
            }).join('');


            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th><i class="fas fa-tag"></i> Название / Описание</th>
                            <th><i class="fas fa-level-up-alt"></i> Уровень</th>
                            <th><i class="fas fa-fire"></i> Тип</th>
                            <th><i class="fas fa-user"></i> Жертва</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        } catch (err) {
            container.innerHTML = `<p class="message error">Ошибка: ${err.message}</p>`;
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('wizardId');
        localStorage.removeItem('wizardLogin');
        window.location.href = '/login.html';
    }

    loadSpells();
</script>
</body>
</html>